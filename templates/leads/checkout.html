{% extends 'base.html' %}
{% block title %}Checkout - {{ report.title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@23.0.11/build/css/intlTelInput.css">
<style>
    .checkout-section {
        background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%) !important;
        background-attachment: fixed !important;
        background-color: #e0f2fe !important;
        min-height: 90vh;
        padding: 4rem 0;
    }

    .checkout-container {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .card-dark {
        background: #0f172a;
        /* Dark Blue */
        border-radius: 8px;
        padding: 2.5rem;
        color: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .form-header h2 {
        color: #60a5fa;
        font-weight: 700;
        margin-bottom: 2rem;
    }

    .form-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.8rem;
        gap: 1rem;
    }

    .form-label {
        flex: 0 0 160px;
        font-weight: 600;
        font-size: 0.85rem;
        color: #cbd5e1;
    }

    .form-input-wrapper {
        flex: 1;
    }

    .form-control {
        flex: 0 0 400px;
        width: 400px !important;
        background: #ffffff !important;
        border: 1px solid #334155 !important;
        padding: 0.75rem 1rem !important;
        border-radius: 6px !important;
        color: #0f172a !important;
        font-size: 0.95rem !important;
    }

    .iti {
        width: 400px !important;
        flex: 0 0 400px;
    }

    .iti__country-list {
        color: #1e293b;
    }

    .iti__search-input {
        width: 100% !important;
        padding: 0.8rem 1rem !important;
        font-size: 1rem !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 6px !important;
        margin-bottom: 0.5rem !important;
        outline: none !important;
        background: #f8fafc !important;
        color: #1e293b !important;
    }

    .iti__search-input:focus {
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        background: #ffffff !important;
    }

    .summary-card {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        border: 1px solid #e2e8f0;
        height: fit-content;
        position: sticky;
        top: 2rem;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .total-price {
        font-size: 2rem;
        font-weight: 800;
        color: #0f172a;
        text-align: right;
    }

    /* Fix overlapping flag/text and style the dial code */
    .iti__selected-dial-code {
        margin-left: 8px;
        font-weight: 500;
        color: #1e293b !important;
    }




    .form-control#id_phone_checkout {
        padding-left: 100px !important;
        /* Ensure enough space for separate dial code */
    }

    .iti__selected-flag {
        background-color: #f1f5f9 !important;
        border-radius: 6px 0 0 6px !important;
    }

    .btn-complete {
        background: #1b6acf;
        color: white;
        font-weight: 700;
        padding: 1rem;
        border-radius: 6px;
        border: none;
        width: 100%;
        margin-top: 2rem;
        font-size: 1.1rem;
        cursor: pointer;
        transition: 0.3s;
    }

    .btn-complete:hover {
        background: #0891b2;
    }

    #id_country_code_wrapper {
        display: none;
    }

    @media (max-width: 900px) {
        .checkout-section {
            padding: 2rem 1rem;
        }

        .checkout-container {
            grid-template-columns: 1fr;
        }

        .card-dark {
            padding: 1.5rem;
        }

        .form-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .form-label {
            flex: none;
            width: 100%;
            margin-bottom: 0.2rem;
        }

        .form-control,
        .iti {
            width: 100% !important;
            flex: none;
        }

        .summary-card {
            order: -1;
            position: static;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="checkout-section">
    <div class="container">
        <div class="checkout-container">

            <!-- Details Form -->
            <div class="card-dark">
                <div class="form-header">
                    <h2>Secure Checkout</h2>
                </div>

                <form method="post" id="checkoutForm">
                    {% csrf_token %}
                    {% if form.errors %}
                    <div class="alert alert-danger" style="color: #f87171; margin-bottom: 2rem;">
                        <strong>Please correct the errors below.</strong>
                    </div>
                    {% endif %}

                    <h4
                        style="margin-bottom: 2rem; color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #334155; padding-bottom: 0.5rem;">
                        Customer Info</h4>

                    <div class="form-row">
                        <label class="form-label">First Name</label>
                        <div class="form-input-wrapper">{{ form.first_name }}</div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Last Name</label>
                        <div class="form-input-wrapper">{{ form.last_name }}</div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Work Email</label>
                        <div class="form-input-wrapper">{{ form.email }}</div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Work Phone</label>
                        <div class="form-input-wrapper">
                            {{ form.phone }}
                            <div id="phone-error"
                                style="color: #f87171; font-size: 0.85rem; margin-top: 0.5rem; display: none;">
                                Please enter a valid phone number for the selected country.
                            </div>
                        </div>
                    </div>
                    <div id="id_country_code_wrapper">{{ form.country_code }}</div>
                    <div class="form-row">
                        <label class="form-label">Company Name</label>
                        <div class="form-input-wrapper">{{ form.company_name }}</div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Job Title</label>
                        <div class="form-input-wrapper">{{ form.designation }}</div>
                    </div>

                    <h4
                        style="margin: 3rem 0 2rem; color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #334155; padding-bottom: 0.5rem;">
                        Billing Address</h4>

                    <div class="form-row">
                        <label class="form-label">Address</label>
                        <div class="form-input-wrapper">{{ form.address }}</div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">City</label>
                        <div class="form-input-wrapper">{{ form.city }}</div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">State</label>
                        <div class="form-input-wrapper">{{ form.state }}</div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Zip Code</label>
                        <div class="form-input-wrapper">{{ form.zip_code }}</div>
                    </div>

                    <div class="form-row">
                        <label class="form-label">Country</label>
                        <div class="form-input-wrapper">{{ form.country }}</div>
                    </div>

                    <!-- Temporarily disabled for testing -->
                    <!--
                    <div style="margin-top: 2rem;">
                        {{ form.captcha }}
                    </div>
                    -->

                    <div id="payment-errors"
                        style="display: none; background: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: 6px; margin-top: 1.5rem;">
                    </div>

                    <div id="form-actions">
                        <button type="submit" class="btn-complete" id="checkoutBtn">Proceed to Payment</button>
                    </div>

                    <div id="paypal-container" style="display: none; margin-top: 2rem;">
                        <h4 style="margin-bottom: 1.5rem; color: #60a5fa;">Pay Securely with PayPal</h4>
                        <div id="paypal-button-container"></div>

                        {% if debug %}
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px dashed #475569;">
                            <h5 style="color: #fbbf24; margin-bottom: 1rem;">Developer Mode</h5>
                            <button type="button" id="devBypassBtn" class="btn-complete"
                                style="background: #334155; color: #94a3b8; font-size: 0.9rem;">
                                Test Payment (Dev Bypass)
                            </button>
                            <p style="color: #64748b; font-size: 0.8rem; margin-top: 0.5rem;">Simulates a successful
                                transaction without PayPal.</p>
                        </div>
                        {% endif %}
                    </div>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="summary-card">
                <h3 style="margin-bottom: 1.5rem; color: #0f172a;">Order Summary</h3>
                <div class="summary-item">
                    <span style="color: #64748b;">Report</span>
                    <span style="font-weight: 600; text-align: right; flex: 1; margin-left: 1rem;">
                        <a href="{% url 'report-detail' report.slug %}" style="color: #2563eb; text-decoration: none;">
                            {{ report.title|truncatewords:4 }}
                        </a>
                    </span>
                </div>
                <div class="summary-item">
                    <span style="color: #64748b;">License</span>
                    <span style="font-weight: 600;">{{ license_label }}</span>
                </div>
                <div class="total-price" style="margin-top: 2rem;">
                    <span style="font-size: 1.1rem; color: #64748b; font-weight: 500;">Total:</span>
                    ${{ price }}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@23.0.11/build/js/intlTelInput.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const phoneInput = document.querySelector("#id_phone_checkout");
        const countryCodeInput = document.querySelector("#id_country_code");
        const phoneError = document.querySelector("#phone-error");

        const iti = window.intlTelInput(phoneInput, {
            initialCountry: "auto",
            geoIpLookup: callback => {
                fetch("https://ipapi.co/json")
                    .then(res => res.json())
                    .then(data => callback(data.country_code))
                    .catch(() => callback("us"));
            },
            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@23.0.11/build/js/utils.js",
            separateDialCode: true,
        });

        let leadId = null;
        const form = document.querySelector("#checkoutForm");

        form.addEventListener('submit', function (e) {
            const btn = document.getElementById('checkoutBtn');
            const errorDiv = document.getElementById('payment-errors');

            // Validate phone number
            phoneError.style.display = 'none';
            if (phoneInput.value.trim()) {
                if (!iti.isValidNumber()) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    phoneError.style.display = 'block';
                    phoneInput.focus();
                    return false;
                }
            }

            e.preventDefault(); // Stop default for AJAX

            // Update country code and country name
            const countryData = iti.getSelectedCountryData();
            if (countryData.dialCode) {
                countryCodeInput.value = "+" + countryData.dialCode;
                console.log("Setting country code to:", countryCodeInput.value);
            }

            // Auto-fill country name if empty
            const countryInput = document.querySelector("#id_country");
            if (countryInput && !countryInput.value && countryData.name) {
                countryInput.value = countryData.name.split(' (')[0];
            }

            btn.innerHTML = 'Saving Details...';
            btn.disabled = true;
            errorDiv.style.display = 'none';

            const formData = new FormData(form);
            formData.append('ajax', 'true');

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        leadId = data.lead_id;
                        document.getElementById('form-actions').style.display = 'none';
                        document.getElementById('paypal-container').style.display = 'block';
                        form.querySelectorAll('input, select, textarea').forEach(input => input.disabled = true);
                        renderPayPalButtons();
                    } else {
                        throw new Error(data.message || 'Error saving details');
                    }
                })
                .catch(error => {
                    btn.innerHTML = 'Proceed to Payment';
                    btn.disabled = false;
                    errorDiv.innerHTML = '<strong>Error:</strong> ' + error.message;
                    errorDiv.style.display = 'block';
                });
        });

        // Helper to get max digits for current country
        const setMaxLength = () => {
            const placeholder = phoneInput.getAttribute('placeholder') || '';
            const maxDigits = placeholder.replace(/\D/g, '').length;
            if (maxDigits > 0) {
                phoneInput.setAttribute('maxlength', maxDigits + 5);
            }
        };

        // Enforce numeric only and max length with strict India validation
        phoneInput.addEventListener('input', function (e) {
            phoneError.style.display = 'none';
            const countryData = iti.getSelectedCountryData();

            // Remove all non-digit characters
            let digits = this.value.replace(/\D/g, '');

            if (countryData && countryData.iso2 === 'in') {
                // Strict 10-digit limit for India
                if (digits.length > 10) {
                    digits = digits.slice(0, 10);
                }
            } else {
                // For other countries, use placeholder-based validation
                const placeholder = phoneInput.getAttribute('placeholder') || '';
                const maxDigits = placeholder.replace(/\D/g, '').length;
                if (maxDigits > 0 && digits.length > maxDigits + 2) {
                    digits = digits.substring(0, maxDigits + 2);
                }
            }

            this.value = digits;
        });

        // Keydown event - prevent typing beyond 10 digits for India
        phoneInput.addEventListener('keydown', function (e) {
            const countryData = iti.getSelectedCountryData();
            if (countryData && countryData.iso2 === 'in') {
                const currentLength = this.value.replace(/\D/g, '').length;
                // Allow: backspace, delete, tab, escape, enter, arrows
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true) ||
                    (e.keyCode >= 35 && e.keyCode <= 39)) {
                    return;
                }
                // Block if already 10 digits
                if (currentLength >= 10) {
                    e.preventDefault();
                }
            }
        });

        // Paste event - trim to 10 digits for India
        phoneInput.addEventListener('paste', function (e) {
            const countryData = iti.getSelectedCountryData();
            if (countryData && countryData.iso2 === 'in') {
                setTimeout(() => {
                    let val = phoneInput.value.replace(/\D/g, '');
                    if (val.length > 10) {
                        val = val.slice(0, 10);
                    }
                    phoneInput.value = val;
                }, 10);
            }
        });

        phoneInput.addEventListener('countrychange', function () {
            phoneInput.value = '';
            setMaxLength();
        });
        setTimeout(setMaxLength, 1000);

        function renderPayPalButtons() {
            // Server-Side Flow: Call backend to create order and get redirect URL
            const btnContainer = document.getElementById('paypal-button-container');
            btnContainer.innerHTML = '<button id="payNowBtn" class="btn-complete" style="background: #fbbf24; color: #1e3a8a;">Pay with PayPal</button>';

            document.getElementById('payNowBtn').addEventListener('click', function () {
                this.innerHTML = 'Redirecting to PayPal...';
                this.disabled = true;

                fetch('{% url "create-paypal-order" %}', {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ lead_id: leadId })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.approve_url) {
                            window.location.href = data.approve_url;
                        } else {
                            throw new Error(data.error || 'Failed to initiate PayPal payment');
                        }
                    })
                    .catch(err => {
                        console.error('PayPal Error:', err);
                        alert('Error: ' + err.message);
                        this.innerHTML = 'Pay with PayPal';
                        this.disabled = false;
                    });
            });

            // Dev Bypass Handler
            const devBtn = document.getElementById('devBypassBtn');
            if (devBtn) {
                devBtn.addEventListener('click', function () {
                    this.innerHTML = 'Simulating Payment...';
                    this.disabled = true;

                    fetch('{% url "dev-bypass" %}', {
                        method: 'POST',
                        headers: {
                            'content-type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ lead_id: leadId })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                alert('Dev Bypass Error: ' + (data.error || 'Unknown error'));
                                this.innerHTML = 'Test Payment (Dev Bypass)';
                                this.disabled = false;
                            }
                        })
                        .catch(err => {
                            alert('Dev Connection Error: ' + err.message);
                            this.innerHTML = 'Test Payment (Dev Bypass)';
                            this.disabled = false;
                        });
                });
            }
        }
    });
</script>
{% endblock %}